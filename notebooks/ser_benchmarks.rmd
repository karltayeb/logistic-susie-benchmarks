---
title: "Single Effect Regression Benchmarks"
format:
  html: 
    code-fold: true
---

```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = '~/Research/logistic-susie-benchmarks/')
```

# Single Effect Regression Benchmarks

## Introduction

There are many ways to approximate the logistic SER. Here we document the relative performance of these different approximations. We investigate a range of simulation scenarios, varying the properties of the design matrix (correlation structure, sparsity), the number of true causal effect ($L = 1, 3, 5$), the strength of effect, etc.

```{r}
library(targets)
library(tidyverse)

cs_scores <- tar_read(ser_cs_coverage, store = '_targets/')
fit_methods <- unique(cs_scores$fit_method)

plot_colors <- c(
  'glm_ser' = 'aquamarine1', 
  'glm_ser2' = 'aquamarine3', 
  'uvb_ser' = 'brown1', 
  'uvb_ser2' = 'brown3', 
  'vb_ser' = 'darkgoldenrod1', 
  'vb_ser2' = 'darkgoldenrod3',
  'vb_ser_corrected' = 'darkorange1',
  'veb_ser' = 'darkorchid1',
  'quad_ser' = 'deeppink1',
  'uvb_ser_re' = 'palevioletred3',
  'jj_abf_ser' = 'royalblue4'
)
plot_colors <- plot_colors[names(plot_colors) %in% fit_methods]
method_order = names(plot_colors)

# coverage for each L
plot_data <- cs_scores %>%
  ungroup() %>%
  group_by(fit_method, L) %>%
  # distribution of mean(covered) over 20 bootstrap iterations
  mutate(coverage = list(purrr::map_dbl(1:20, ~mean(sample(covered, replace = T))))) %>%
  select(fit_method, coverage, L) %>%
  unnest_longer(coverage)

plot_data %>% dplyr::pull(fit_method) %>% unique()
```

```{r}
plot <- plot_data %>%
  ggplot(aes(x=factor(fit_method, level = names(plot_colors)), y=coverage, fill=fit_method)) +
  geom_boxplot(outlier.shape=NA) + facet_wrap(vars(L)) +
  scale_fill_manual(values=plot_colors) +
  theme(axis.text.x = element_blank())
plot
```



```{r}
# coverage conditional on CS size
plot_data <- cs_scores %>%
  ungroup() %>%
  hoist(cs, size='size') %>%
  mutate(size_bin = cut(size, c(0, 1, 5, 10, 50))) %>%
  group_by(fit_method, size_bin, L) %>%
  mutate(coverage = list(purrr::map_dbl(1:50, ~mean(sample(covered, replace = T))))) %>%
  select(fit_method, size_bin, coverage, L) %>%
  unnest_longer(coverage)

plot <- plot_data %>% 
  ggplot(aes(x=size_bin, y=coverage, fill=factor(fit_method, level=method_order))) +
  geom_boxplot(outlier.shape=NA) + facet_grid(rows=vars(L)) +
  scale_fill_manual(values=plot_colors)

plot
```


```{r}
roc_plot_data <- tar_read(ser_pip_roc, store='_targets/')

roc_plot_data %>%
  ggplot(aes(d=causal, m = pip, color=fit_method)) +
  plotROC::geom_roc(n.cuts = 0, size.point=1, size=0.5) + 
  scale_color_manual(values=plot_colors) +
  xlim(0, 0.2) + 
  ylim(0, 0.4)
```

```{r}
get_y_range <- function(y){
  res <- quantile(purrr::map_dbl(1:50, ~mean(sample(y, replace = T))), c(0.05, 0.5, 0.95))
  names(res) <- c('ymin', 'y', 'ymax')
  return(as.list(res))
}

make_pip_calibration_plot <- function(pips, facets = 'fit_method'){
  pip_bins <- seq(0, 1.0, by=0.05)

  pip_calibration_data <- pips %>%
    mutate(pip_bin = cut(pip, pip_bins, labels=F)) %>%
    mutate(pip_bin = seq(0.05, 1.0, by=0.05)[pip_bin]) %>%
    select(-pip) %>%
    group_by(across(c(facets, 'pip_bin'))) %>%
    summarise(
      size = n(),
      y_range = list(get_y_range(causal))
    ) %>% 
    unnest_wider(y_range) %>%
    ungroup()
  
  plot <- pip_calibration_data %>%
    ggplot(aes(x=pip_bin, y=y, ymin=ymin, ymax=ymax)) + 
    geom_pointrange(size=0.1) +
    geom_abline(intercept = 0, slope = 1, color='red') +
    facet_wrap(as.formula(paste("~", facets))) + 
    theme_bw()
    
  return(plot)
}


pips <- tar_read(ser_score_pips)

pips <- pips %>% 
  unnest_longer(c(pip, causal)) %>%
  select(y_name, fit_method, L, pip, causal)

make_pip_calibration_plot(pips %>% filter(L == 1), facets = 'fit_method')
make_pip_calibration_plot(pips %>% filter(L == 3), facets = 'fit_method')
make_pip_calibration_plot(pips %>% filter(L == 5), facets = 'fit_method')
```

```{r}
# coverage of SERs for different true L
cs_scores %>%
  ungroup() %>%
  hoist(cs, size='size') %>%
  group_by(fit_method, L) %>%
  mutate(coverage = list(purrr::map_dbl(1:100, ~mean(sample(covered, replace = T))))) %>%
  select(fit_method, L, coverage) %>%
  unnest_longer(coverage) %>%
  ggplot(aes(x=factor(L), y=coverage, fill=factor(fit_method, levels = method_order))) +
  scale_fill_manual(values=plot_colors) + 
  geom_boxplot(outlier.shape=NA)
```

