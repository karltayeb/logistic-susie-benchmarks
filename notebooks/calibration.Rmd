---
title: "PIP Calibration"
author: "Karl Tayeb"
date: "2022-12-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Calibration

We assess the calibration of PIPs and credible sets for various SERs and SuSiEs.

### Simulations 

We simulate data under the model

$$
y_i \sim Bernoulli(p_i) \\
p_i = (1 + \exp(\beta_0 +x_i^T \beta))^{-1} \\
\beta \sim \text{SuSiE}(L, \sigma_{b}^2)
$$
We vary the prior variance of the non-zero effects to have  $\mathbb E b = 0.2, 0.4, 0.6, 0.8, 1.0, 2.0$
The intercept $\beta_0$ gives the prior odds of $y_i = 1$, which we set to $\beta_0 = -2, -1, 0.5, 1$
We simulate under the single effect case $L=1$, and also multiple effects $L=3$
We replicate each simulation scenario 20 times.


We repeat these simulations with different design matrices $X$. In all cases we simulate $n=1000$ observations and $p=50$ covariates. We control the correlation structure between the $p$ covariates so that covariates are weakly, moderately, and strongly correlated. In all case presented here we standardize $X$ before model fitting to have mean 0 and variance 1. 

```
  lengthscales <- c(1, 10, 50)
  beta0 <- c(-2, -1, -.5, 0)
  beta_sigma <- c(0.2, 0.4, 0.6, 0.8, 1.0, 2.0) / sqrt(2/pi)
  L <- c(1, 3) #c(1, 3, 5)
  reps <-  1:20
```

```{r}
library(tidyverse)
library(targets)
```

```{r}
get_y_range <- function(y){
  res <- quantile(purrr::map_dbl(1:50, ~mean(sample(y, replace = T))), c(0.05, 0.5, 0.95))
  names(res) <- c('ymin', 'y', 'ymax')
  return(as.list(res))
}

make_pip_calibration_plot <- function(pips, facet = 'fit_method'){
  pip_bins <- seq(0, 1.0, by=0.05)

  pip_calibration_data <- pips %>%
    mutate(pip_bin = cut(pip, pip_bins, labels=F)) %>%
    mutate(pip_bin = seq(0.05, 1.0, by=0.05)[pip_bin]) %>%
    select(-pip) %>%
    group_by(across(c(facet, 'pip_bin'))) %>%
    summarise(
      size = n(),
      y_range = list(get_y_range(causal))
    ) %>% 
    unnest_wider(y_range) %>%
    ungroup()
  
  plot <- pip_calibration_data %>%
    ggplot(aes(x=pip_bin, y=y, ymin=ymin, ymax=ymax)) + 
    geom_pointrange(size=0.1) +
    geom_abline(intercept = 0, slope = 1, color='red') +
    facet_wrap(as.formula(paste("~", facet))) + 
    theme_bw()
    
  return(plot)
}
```


```{r}
# get pips
pips <- tar_read(half_normal_pips)
pips <- pips %>% 
  unnest_longer(c(pip, causal)) %>%
  select(y_name, fit_method, L, pip, causal)
```


### L = 1

Calibration of PIPs in the single-effect simulations

```{r}
pips %>%
  filter(L == 1, stringr::str_detect(fit_method, 'ser')) %>%
  make_pip_calibration_plot(facet = 'fit_method')
```


```{r}
pips %>%
  filter(L == 1, stringr::str_detect(fit_method, 'susie')) %>%
  make_pip_calibration_plot(facet = 'fit_method')
```


### Multiple effects


```{r}
pips %>%
  filter(L > 1, stringr::str_detect(fit_method, 'ser')) %>%
  make_pip_calibration_plot(facet = 'fit_method')
```

```{r}
pips %>%
  filter(L > 1, stringr::str_detect(fit_method, 'susie')) %>%
  make_pip_calibration_plot(facet = 'fit_method')
```
## Credible Sets

```{r}
tar_load(half_normal_cs)

# 1 row, 1 simulation
cs <- half_normal_cs %>%
  hoist(score_cs, cs='cs') %>%
  unnest_wider(sims) %>%
  unnest_longer(everything())

# 1 row, 1 credible set
cs <- cs %>%
  unnest_longer(cs) %>%
  hoist(cs, 'covered') %>%
  rowwise() %>% mutate(covered = any(covered))

make_coverage_plot <- function(cs){
  coverage_plot_data <- cs %>% 
  group_by(fit_method, X_name, L) %>%
  summarise(
    size = n(),
    y_range = list(get_y_range(covered))
  ) %>% 
  unnest_wider(y_range) %>%
  ungroup()
  
coverage_plot_data %>%
  ggplot(aes(x=as.factor(L), y=y, ymin=ymin, ymax=ymax, color=as.factor(X_name))) +
  geom_pointrange(position=position_dodge(0.3)) + 
  geom_hline(yintercept = 0.95, size=0.1) + 
  facet_wrap(vars(fit_method)) +
  theme_bw()
}
```

```{r}
cs %>%
  filter(stringr::str_detect(fit_method, 'ser')) %>%
  make_coverage_plot()
```

```{r}
cs %>%
  filter(stringr::str_detect(fit_method, c('susie|ibss'))) %>%
  make_coverage_plot()
```

```{r}
make_size_plot <- function(cs){
  size_plot_data <- cs %>% 
    hoist(cs, cs_size = 'size')
  
  size_plot_data <- size_plot_data[size_plot_data$cs_size < 51,] %>%
    group_by(fit_method, X_name, beta_sigma) %>%
    summarise(sizes = list(cs_size)) %>%
    rowwise() %>%
    mutate(y_range = list(get_y_range(sizes))) %>%
    ungroup() %>%
    unnest_wider(y_range)
  
  plot <- size_plot_data %>%
    ggplot(aes(x=beta_sigma, y=y, ymin=ymin, ymax=ymax, color=as.factor(X_name))) +
    geom_point(position=position_dodge(0.3)) + 
    facet_wrap(vars(fit_method)) +
    theme_bw()
  return(plot)
}

cs %>%
  filter(stringr::str_detect(fit_method, 'ser')) %>%
  make_size_plot()
  
cs %>%
  filter(stringr::str_detect(fit_method, 'susie|ibss')) %>%
  make_size_plot()
```



