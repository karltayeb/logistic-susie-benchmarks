---
title: "PIP Calibration"
author: "Karl Tayeb"
date: "2022-12-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Calibration

We assess the calibration of PIPs and credible sets for various SERs and SuSiEs.

## Description
### Simulations 

We simulate data under the model

$$
y_i \sim Bernoulli(p_i) \\
p_i = (1 + \exp(\beta_0 +x_i^T \beta))^{-1} \\
\beta \sim \text{SuSiE}(L, \sigma_{b}^2)
$$
We vary the prior variance of the non-zero effects to have  $\mathbb E b = 0.2, 0.4, 0.6, 0.8, 1.0, 2.0$
The intercept $\beta_0$ gives the prior odds of $y_i = 1$, which we set to $\beta_0 = -2, -1, 0.5, 1$
We simulate under the single effect case $L=1$, and also multiple effects $L=3$
We replicate each simulation scenario 20 times.


We repeat these simulations with different design matrices $X$. In all cases we simulate $n=1000$ observations and $p=50$ covariates. We control the correlation structure between the $p$ covariates so that covariates are weakly, moderately, and strongly correlated. In all case presented here we standardize $X$ before model fitting to have mean 0 and variance 1. 

```
  lengthscales <- c(1, 10, 50)
  beta0 <- c(-2, -1, -.5, 0)
  beta_sigma <- c(0.2, 0.4, 0.6, 0.8, 1.0, 2.0) / sqrt(2/pi)
  L <- c(1, 3) #c(1, 3, 5)
  reps <-  1:20
```

### Methods Assessed

We assess the performance of the linear SER and several approximations to the logistic SER.
We also assess the performance of several SuSiE variants. As a baseline we run linear SuSiE.
We fit logistic SuSiE with the global variational approximation, IBSS, and IBSS2M.

## PIP Calibration

```{r}
library(dplyr)
library(tidyr)
library(targets)
library(ggplot2)
```

```{r}
# get pips
pips <- tar_read(half_normal_pips)
pips <- pips %>% 
  unnest_longer(c(pip, causal)) %>%
  select(y_name, fit_method, L, pip, causal)
```

### Calibration of SERs uner $L=1$ simulations

Calibration of PIPs in the single-effect simulations

```{r}
pips %>%
  filter(L == 1, stringr::str_detect(fit_method, 'ser')) %>%
  make_pip_calibration_plot(facet = 'fit_method')
```

### Calibration of SuSiEs under $L=1$ simulations

```{r}
pips %>%
  filter(L == 1, stringr::str_detect(fit_method, 'susie')) %>%
  make_pip_calibration_plot(facet = 'fit_method')
```


### Calibration of SERs under $L>1$ simulations


```{r}
pips %>%
  filter(L > 1, stringr::str_detect(fit_method, 'ser')) %>%
  make_pip_calibration_plot(facet = 'fit_method')
```

### Calibration of SuSiEs under $L>1$ simulations

```{r}
pips %>%
  filter(L > 1, stringr::str_detect(fit_method, 'susie|ibss')) %>%
  make_pip_calibration_plot(facet = 'fit_method')
```

## Credible Sets

```{r}
cs <- tar_read(half_normal_cs)

# 1 row, 1 simulation
cs <- cs %>%
  hoist(score_cs, cs='cs') %>%
  unnest_wider(sims) %>%
  unnest_longer(everything())

# 1 row, 1 credible set
cs <- cs %>%
  unnest_longer(cs) %>%
  rowwise() %>%
  mutate(covered = any(cs$covered), cs_size=cs$size)
```

### Coverage of SERs 95% Credible Sets

```{r}
cs %>%
  filter(stringr::str_detect(fit_method, 'ser')) %>%
  make_coverage_plot()
```

```{r}
cs %>%
  filter(stringr::str_detect(fit_method, 'ser')) %>%
  make_coverage_plot(max_size=25)
```
### Coverage of SERs 95% Credible Sets

```{r}
cs %>%
  filter(stringr::str_detect(fit_method, c('susie|ibss'))) %>%
  make_coverage_plot()
```
```{r}
cs %>%
  filter(stringr::str_detect(fit_method, c('susie|ibss'))) %>%
  make_coverage_plot(max_size=25)
```

```{r}
cs %>%
  filter(stringr::str_detect(fit_method, c('susie|ibss'))) %>%
  make_coverage_plot()
```


## Power

```{r}
plot_colors <- c(
  'glm_ser' = 'aquamarine1', 
  'glm_ser2' = 'aquamarine3', 
  'uvb_ser' = 'brown1', 
  'uvb_ser2' = 'brown3', 
  'vb_ser' = 'darkgoldenrod1', 
  'vb_ser2' = 'darkgoldenrod3',
  'vb_ser_corrected' = 'darkorange1',
  'veb_ser' = 'darkorchid1',
  'quad_ser' = 'deeppink1',
  'uvb_ser_re' = 'palevioletred3',
  'linear_ser' = 'royalblue4',
  
  'ibss_glm_L5' = 'aquamarine1', 
  'ibss_glm2_L5' = 'aquamarine3', 
  'ibss_uvb_L5' = 'brown1', 
  'ibss_uvb2_L5' = 'brown3', 
  'ibss_vb_L5' = 'darkgoldenrod1', 
  'ibss_vb2_L5' = 'darkgoldenrod3',
  'ibss_vbc_L5' = 'darkorange1',
  'binsusie_L5' = 'olivedrab3',
  'binsusie2_L5' = 'olivedrab4',
  'ibss2m_L5' = 'brown3',
  'linear_susie_L5' =  'royalblue4'
)
```

```{r}
methods <- unique(pips$fit_method)
methods <- methods[stringr::str_detect(methods, 'ser')]
colors <- plot_colors[methods]

pips %>%
  filter(stringr::str_detect(fit_method, c('ser'))) %>%
  ggplot(aes(d=causal, m = pip, color=fit_method)) +
  plotROC::geom_roc(n.cuts = 0, size.point=1, size=0.5) + 
  scale_color_manual(values=colors) +
  xlim(0, 0.1) +
  ylim(0, 0.5)
```

```{r}
pips %>% 
  filter(stringr::str_detect(fit_method, c('ser'))) %>% 
  make_power_fdr_plot(colors=plot_colors) +
  xlim(0, 0.25) +
  ylim(0, 0.15)
```


```{r}
methods <- unique(pips$fit_method)
methods <- methods[stringr::str_detect(methods, 'susie|ibss')]
colors <- plot_colors[methods]

pips %>%
  filter(stringr::str_detect(fit_method, c('susie|ibss'))) %>%
  ggplot(aes(d=causal, m = pip, color=fit_method)) +
  plotROC::geom_roc(n.cuts = 0, size.point=1, size=0.5) + 
  scale_color_manual(values=colors) +
  xlim(0, 0.1) +
  ylim(0, 0.75)
```

```{r}
pips %>% 
  filter(stringr::str_detect(fit_method, c('susie|ibss'))) %>% 
  make_power_fdr_plot(colors=plot_colors)
```

```{r}
make_size_plot <- function(cs){
  size_plot_data <- cs %>% 
    hoist(cs, cs_size = 'size')
  
  size_plot_data <- size_plot_data[size_plot_data$cs_size < 51,] %>%
    group_by(fit_method, X_name, beta_sigma) %>%
    summarise(sizes = list(cs_size)) %>%
    rowwise() %>%
    mutate(y_range = list(get_y_range(sizes))) %>%
    ungroup() %>%
    unnest_wider(y_range)
  
  plot <- size_plot_data %>%
    ggplot(aes(x=beta_sigma, y=y, ymin=ymin, ymax=ymax, color=as.factor(X_name))) +
    geom_point(position=position_dodge(0.3)) + 
    facet_wrap(vars(fit_method)) +
    theme_bw()
  return(plot)
}

cs %>%
  filter(stringr::str_detect(fit_method, 'ser')) %>%
  make_size_plot()
  
cs %>%
  filter(stringr::str_detect(fit_method, 'susie|ibss')) %>%
  make_size_plot()
```



